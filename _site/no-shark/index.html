<!DOCTYPE html>
<html>
<head>
    <!--
    * Author:         pystone(based on BeiYuu)
    -->
    <meta charset="utf-8" />
    <title>退shark保平安 | ySite</title>
    <meta name="author" content="pystone" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="pystone's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">ySite</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/pystone/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://github.com/pystone" target="_blank" style="text-align:center;"><img src="https://www.github.com/favicon.ico" alt="" width="22"/></a>
            <a href="http://instagram.com/pystone/" target="_blank" style="text-align:right"><img src="http://d36xtkk24g8jdx.cloudfront.net/bluebar/00c6602/images/ico/favicon.ico" alt="" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/no-shark" title="退shark保平安">退shark保平安</a></h1>
        <p class="entry-date">2014-06-19</p>
        <p>在国内远程上15213的筒子们，碰到必须要在shark上做的lab必定是蛋疼菊紧。因为在国内ssh连上shark一个按键需要n(n>=1)秒才能得到反馈的感觉真是想把电脑砸了。但是如果在本机跑，“Initialization error: Running on an illegal host”的错误让你不得不乖乖回到shark的怀抱。今儿咱就不九评shark了，直接给你指条明路，施主请退shark保平安。</p>

<p><strong>注意：在决定退shark之前请务必有一个64位的linux环境来运行lab的程序，以datalab中能顺利运行driver.pl为准！</strong></p>

<p>以bomblab为例，我们来看下该怎么在非shark平台运行bomb。首先我们通过strings查看所有字符串，确定“Initialization error: Running on an illegal host”这个错误提示是在哪里被引用的。我的bomb里的偏移是29a0。然后回到bomb的反汇编里面查看，这个偏移是在initialize_bomb这个函数里面。初步怀疑是这个函数在检测程序的运行环境，索性把这个调用指令删掉试试看。</p>

<h2>屏蔽initialize_bomb函数的调用指令</h2>

<p>屏蔽的主要思想是把调用指令改写成90(nop)指令。首先第一步咱要找到这个调用指令的位置。查看bomb的汇编，找到main函数中<code>callq  4015ed &lt;initialize_bomb&gt;</code>指令的地址。例如我这个bomb的地址是400d57。同时记下该指令的机器码“e8 91 08 00 00”。</p>

<p><img src="/images/no_shark/main_initialize_bomb.png"></p>

<p>接下来就要修改二进制文件。在terminal中输入：</p>

<pre><code>vim -b bomb
</code></pre>

<p>来编辑bomb。打开后会看到一堆乱码，别急，继续输入：</p>

<pre><code>:%!xxd
</code></pre>

<p>有没有觉得世界瞬间清净了！！你可以非常方便的查看每个位置的数据了。找到000d57位置，确认该位置之后的5个字节的内容是刚才我们记下的机器码“e8 91 08 00 00”。</p>

<p><img src="/images/no_shark/before_edit.png"></p>

<p>确认无误之后把这五个字节的内容删除，然后输入“90 90 90 90 90”。</p>

<p><img src="/images/no_shark/after_edit.png"></p>

<p>很好，现在就修改成功了。最后输入：</p>

<pre><code>:%!xxd -r
</code></pre>

<p>回到乱码界面，再输入：</p>

<pre><code>:x
</code></pre>

<p>保存并退出。好了，再在非shark机运行bomb就不会报错了。也不会对实验结果造成影响。</p>

<p>p.s. 我们在最开始记录的地址是400d57，而在修改bomb的二进制文件时修改的却是000d57位置上的值。其实这是因为汇编中的地址实际是virtual address，而打开的二进制文件时是实际相对文件开头的offset。具体的信息可以查看<a href="http://book.douban.com/subject/1436811/"><em>Linkers and Loaders</em></a>这本书，或者<a href="http://book.douban.com/subject/3652388/">《程序员的自我修养》</a>。</p>

<h2>修改host name</h2>

<p>上面的方法虽然能够正常运行，但是直接修改了binary，未免显得太过暴力。咱是文明人，这种一上来直接搞破坏的事咱还是尽量少做。那我们就来进一步分析下initialize_bomb这个函数，看有没有其他的方法来绕过检测。</p>

<p>回到initialize_bomb函数中，仔细看<code>mov    $0x4029a0,%edi</code>这条指令之前的指令，发现一条可疑指令<code>callq  400b70 &lt;gethostname@plt&gt;</code>。再稍微看下该指令之后的指令，可以发现只有gethostname函数的返回值为0的时候才算检测成功。</p>

<p><img src="/images/no_shark/initialize_bomb.png"></p>

<p>那我们再稍微查一下gethostname的作用，发现这是用来获取host name的函数（<a href="http://linux.die.net/man/2/gethostname">http://linux.die.net/man/2/gethostname</a>）。在shark中运行一下这个函数查看shark的host name，发现就是该台shark机的域名（例如bambooshark.ics.cs.cmu.edu）。</p>

<p>于是可以考虑把本机名改成shark的host name来骗过这个检测。既然有gethostname函数，那应该也会有sethostname函数。一查果不其然，可以利用sethostname函数来修改本机的host name（<a href="http://linux.die.net/man/2/sethostname">http://linux.die.net/man/2/sethostname</a>）。参照用法，写一个小程序（chg_hostname.c）修改了host name之后再运行bomb，正常运行。</p>

<pre><code>#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main() {
    char hostname[100] = {0};
    int res = gethostname(hostname, sizeof(hostname));
    printf("Old host name: %s. (Return %d)\n", hostname, res);

    strcpy(hostname, "bambooshark.ics.cs.cmu.edu");

    res = sethostname(hostname, strlen(hostname));
    gethostname(hostname, sizeof(hostname));
    printf("New host name: %s. (Return %d)\n", hostname, res);
    return 0;
}
</code></pre>

<p>或者也可以直接通过</p>

<pre><code>git clone https://gist.github.com/87ead03a9c3a75660bb9.git
</code></pre>

<p>获得代码。</p>

<h2>后记</h2>

<p>Have fun playing with the labs~</p>


        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
                <script type="text/javascript" charset="utf-8">
                (function(){
                  var _w = 86 , _h = 16;
                  var param = {
                    url:location.href,
                    type:'6',
                    count:'', /**是否显示分享数，1显示(可选)*/
                    appkey:'', /**您申请的应用appkey,显示分享来源(可选)*/
                    title:'', /**分享的文字内容(可选，默认为所在页面的title)*/
                    pic:'', /**分享图片的路径(可选)*/
                    ralateUid:'1982372384', /**关联用户的UID，分享微博会@该用户(可选)*/
                    language:'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/
                    rnd:new Date().valueOf()
                  }
                  var temp = [];
                  for( var p in param ){
                    temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
                  }
                  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')
                })()
                </script>
            </div>
            <a href="#" class="comment" onclick="return false;">点击查看评论</a>
            <div id="disqus_thread"></div>
        </div>
    </div>

    <div class="sidenav">
      <iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=75&fansRow=2&ptype=1&speed=0&skin=3&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=1982372384&verifier=014c719a&colors=d6f3f7,ffffff,666666,0d61d4,ecfbfd&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Tech</h2>
        <ul class="artical-list">
        
            <li><a href="/no-shark">退shark保平安</a></li>
        
            <li><a href="/think-in-bitwise">Think in bitwise</a></li>
        
            <li><a href="/write-your-own-linux-shell">Write your own linux shell</a></li>
        
        </ul>

        <h2>Life</h2>
        <ul class="artical-list">
        
            <li><a href="/memorial-to-the-sysucpc14">My final CPC: memorial to SYSUCPC 14'</a></li>
        
            <li><a href="/change-the-look-of-my-blog">Change the look of my blog</a></li>
        
            <li><a href="/my-new-blog">Switch to GitHub Pages + Jekyll!</a></li>
        
        </ul>

    </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>


    <!--**********************************-->
    <!--****** Statistic code begin ******-->
    <!--******  Remember to delete  ******-->
    <!--**********************************-->
    <div class="hide">
        <script type="text/javascript" src="http://js.tongji.linezing.com/3424900/tongji.js"></script>
        <noscript><a href="http://www.linezing.com"><img src="http://img.tongji.linezing.com/3424900/tongji.gif"/></a></noscript>
    </div>
    <!--**********************************-->
    <!--******  Statistic code end  ******-->
    <!--******  Remember to delete  ******-->
    <!--**********************************-->

    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })
    </script>
</body>
</html>
